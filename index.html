<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="theme-color" content="#991b1b">
    <title>å°å¤§æ‹³æ“Šç¤¾é»åç³»çµ±</title>
    
    <script src="https://unpkg.com/react@18/umd/react.production.min.js" crossorigin></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js" crossorigin></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>

    <style>
        body { -webkit-user-select: none; user-select: none; -webkit-tap-highlight-color: transparent; }
        input, select { -webkit-user-select: auto; user-select: auto; }
        @keyframes fade-in { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        @keyframes scale-in { from { opacity: 0; transform: scale(0.9); } to { opacity: 1; transform: scale(1); } }
        .animate-fade-in { animation: fade-in 0.3s ease-out; }
        .animate-slide-in { animation: fade-in 0.3s ease-out; }
        .animate-scale-in { animation: scale-in 0.3s ease-out; }
    </style>
</head>
<body class="bg-gray-100 min-h-screen">
    <!-- éš±è—çš„ iframe (çµ¦ Google Form ç”¨çš„) -->
    <iframe name="hidden_iframe" id="hidden_iframe" style="display:none;"></iframe>
    
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect } = React;

        // ==========================================
        // ğŸ”‘ å…©å¤§å¾Œå°è¨­å®šå€
        // ==========================================
        
        // è·¯ç·š Aï¼šè³¼èª²/é«”é©— (ç›´é€£ Google Form)
        const FORM_URL = "https://docs.google.com/forms/d/e/1FAIpQLSczkOvnq-sgwquckGdhvPryDrs-b1y4kWtZM0hYGcH5UgQKFg/formResponse";

        // è·¯ç·š Bï¼šç¤¾å“¡ç°½åˆ° & è®€å–æœƒå“¡åå–® (å°æ¥ Google Apps Script)
        // âš ï¸ å·²ç¶“æ›´æ–°ç‚ºæ‚¨æœ€æ–°å–å¾—çš„ /exec ç¶²å€
        const GOOGLE_SCRIPT_URL = "https://script.google.com/macros/s/AKfycbwYmVBUg31Beu75yPhXyrFL7NPuCWVv4Rpzj0GW3OCWXu7N_RTga6OeAI72GcU09M2Q/exec"; 
        
        // ==========================================

        const copyToClipboard = (text) => {
            const textArea = document.createElement("textarea");
            textArea.value = text;
            document.body.appendChild(textArea);
            textArea.select();
            try { document.execCommand('copy'); alert(`å·²è¤‡è£½: ${text}`); } catch (err) {}
            document.body.removeChild(textArea);
        };

        const User = ({size=24}) => <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M19 21v-2a4 4 0 0 0-4-4H9a4 4 0 0 0-4 4v2"/><circle cx="12" cy="7" r="4"/></svg>;
        const Check = ({size=24, className}) => <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><polyline points="20 6 9 17 4 12"/></svg>;
        const CreditCard = ({size=24}) => <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><rect width="20" height="14" x="2" y="5" rx="2"/><line x1="2" x2="22" y1="10" y2="10"/></svg>;
        const ArrowLeft = ({size=24}) => <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="m12 19-7-7 7-7"/><path d="M19 12H5"/></svg>;
        const Copy = ({size=16, className}) => <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><rect width="14" height="14" x="8" y="8" rx="2" ry="2"/><path d="M4 16c-1.1 0-2-.9-2-2V4c0-1.1.9-2 2-2h10c1.1 0 2 .9 2 2"/></svg>;
        const AlertCircle = ({size=18, className}) => <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><circle cx="12" cy="12" r="10"/><line x1="12" x2="12" y1="8" y2="12"/><line x1="12" x2="12.01" y1="16" y2="16"/></svg>;
        const Users = ({size=32}) => <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M16 21v-2a4 4 0 0 0-4-4H6a4 4 0 0 0-4 4v2"/><circle cx="9" cy="7" r="4"/><path d="M22 21v-2a4 4 0 0 0-3-3.87"/><path d="M16 3.13a4 4 0 0 1 0 7.75"/></svg>;
        const GraduationCap = ({size=32}) => <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M22 10v6M2 10l10-5 10 5-10 5z"/><path d="M6 12v5c3 3 9 3 12 0v-5"/></svg>;

        const Header = () => (
            <div className="bg-red-800 text-white p-4 shadow-md flex items-center justify-center sticky top-0 z-10 safe-top">
                <h1 className="text-xl font-bold tracking-wider">NTU BOXING é»åç³»çµ±</h1>
            </div>
        );

        const BackButton = ({ to, setPage }) => (
            <button type="button" onClick={() => setPage(to)} className="flex items-center text-gray-500 mb-6 hover:text-red-800 transition-colors">
                <ArrowLeft size={20} /> <span className="ml-1">è¿”å›</span>
            </button>
        );

        const IdentityCard = ({ icon: Icon, title, subtitle, onClick, colorClass = "border-red-800 text-red-800" }) => (
            <button type="button" onClick={onClick} className={`w-full group relative overflow-hidden bg-white border-2 ${colorClass} rounded-2xl p-6 shadow-md active:scale-95 transition-all hover:bg-gray-50 flex flex-col items-center gap-2`}>
                <Icon size={32} />
                <span className="text-xl font-bold">{title}</span>
                <span className="text-xs opacity-75">{subtitle}</span>
            </button>
        );

        const HomePage = ({ setPage }) => (
            <div className="flex flex-col gap-4 p-6 animate-fade-in pb-12">
                <div className="text-center mb-2">
                    <p className="text-gray-600 text-lg">æ­¡è¿ä¾†åˆ°å°å¤§æ‹³æ“Šç¤¾</p>
                    <p className="text-sm text-gray-500">è«‹é¸æ“‡æ‚¨çš„æœå‹™</p>
                </div>
                <button type="button" onClick={() => setPage('member_select')} className="group bg-white border-2 border-red-800 text-red-800 rounded-2xl p-6 shadow-lg active:scale-95 transition-all hover:bg-red-50">
                    <div className="flex items-center justify-between">
                        <div className="flex flex-col items-start"><span className="text-2xl font-bold">æˆ‘æ˜¯ç¤¾å“¡</span><span className="text-sm opacity-75">Member Check-in</span></div>
                        <User size={40} />
                    </div>
                </button>
                <button type="button" onClick={() => setPage('purchase_select')} className="group bg-slate-100 border-2 border-slate-600 text-slate-800 rounded-2xl p-6 shadow-lg active:scale-95 transition-all hover:bg-slate-200">
                    <div className="flex items-center justify-between">
                        <div className="flex flex-col items-start"><span className="text-2xl font-bold">è³¼è²·èª²ç¨‹</span><span className="text-sm opacity-75">Purchase Course</span></div>
                        <CreditCard size={40} />
                    </div>
                </button>
                <button type="button" onClick={() => setPage('trial')} className="group bg-slate-800 text-white rounded-2xl p-6 shadow-lg active:scale-95 transition-all hover:bg-slate-700">
                    <div className="flex items-center justify-between">
                        <div className="flex flex-col items-start"><span className="text-2xl font-bold">æˆ‘è¦é«”é©—</span><span className="text-sm opacity-75">Single Trial Class</span></div>
                        <Check size={40} />
                    </div>
                </button>
                <div className="mt-4 text-center">
                    <p className="text-xs text-gray-400">Â© 2026 NTU Boxing Club</p>
                </div>
            </div>
        );

        const IdentitySelectPage = ({ title, nextStep, setPage, setIdentityType }) => (
            <div className="p-6 animate-slide-in">
                <BackButton to="home" setPage={setPage} />
                <h2 className="text-2xl font-bold text-gray-800 mb-2">{title}</h2>
                <p className="text-gray-500 mb-6">è«‹é¸æ“‡æ‚¨çš„èº«ä»½é¡åˆ¥</p>
                <div className="flex flex-col gap-4">
                    <IdentityCard icon={GraduationCap} title="å°å¤§æ•™è·å“¡å·¥ç”Ÿ" subtitle="NTU Students / Faculty" onClick={() => { setIdentityType('ntu'); setPage(nextStep); }} />
                    <IdentityCard icon={Users} title="æ ¡å¤–äººå£«" subtitle="External Members" colorClass="border-slate-600 text-slate-800" onClick={() => { setIdentityType('external'); setPage(nextStep); }} />
                </div>
            </div>
        );

        const MemberFormPage = ({ setPage, identityType, memberData, setMemberData, loading, submitToForm, handleStudentIdChange }) => (
            <div className="p-6 animate-slide-in">
                <BackButton to="member_select" setPage={setPage} />
                <h2 className="text-2xl font-bold text-red-900 mb-2 border-l-4 border-red-800 pl-3">{identityType === 'ntu' ? 'å°å¤§ç¤¾å“¡ç°½åˆ°' : 'æ ¡å¤–ç¤¾å“¡ç°½åˆ°'}</h2>
                <p className="text-sm text-gray-500 mb-6 pl-4">ç³»çµ±æœƒè‡ªå‹•è¨˜éŒ„æ‚¨ç•¶ä¸‹çš„æ‰“å¡æ™‚é–“</p>
                <form onSubmit={(e) => { e.preventDefault(); submitToForm(memberData, 'Member'); }} className="flex flex-col gap-4">
                    {identityType === 'ntu' ? (
                        <div>
                            <label className="block text-sm font-medium text-gray-700 mb-1">å­¸è™Ÿ (Student ID)</label>
                            <input type="text" required placeholder="ä¾‹å¦‚: B12345678" className="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-red-500 outline-none uppercase font-mono tracking-wider" value={memberData.studentId} onChange={(e) => handleStudentIdChange(e, setMemberData, memberData)} />
                        </div>
                    ) : (
                        <div>
                            <label className="block text-sm font-medium text-gray-700 mb-1">æ‰‹æ©Ÿè™Ÿç¢¼</label>
                            <input type="tel" required placeholder="09xxxxxxxx" className="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-slate-600 outline-none font-mono" value={memberData.phone} onChange={(e) => setMemberData({...memberData, phone: e.target.value})} />
                        </div>
                    )}
                    <div><label className="block text-sm font-medium text-gray-700 mb-1">å§“å (éœ€èˆ‡è¡¨å–®ä¸€è‡´)</label><input type="text" required className="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-red-500 outline-none" value={memberData.name} onChange={(e) => setMemberData({...memberData, name: e.target.value})} /></div>
                    <button type="submit" disabled={loading} className={`mt-4 w-full text-white py-4 rounded-xl font-bold text-lg shadow-md active:scale-95 transition-all disabled:opacity-50 flex justify-center items-center ${identityType === 'ntu' ? 'bg-red-800 hover:bg-red-900' : 'bg-slate-800 hover:bg-slate-900'}`}>{loading ? "è™•ç†ä¸­..." : "ç¢ºèªç°½åˆ°"}</button>
                </form>
            </div>
        );

        const PurchaseFormPage = ({ setPage, identityType, purchaseData, setPurchaseData, loading, submitToForm, handleStudentIdChange }) => {
            const price = identityType === 'ntu' ? 3000 : 3500;
            return (
                <div className="p-6 animate-slide-in">
                    <BackButton to="purchase_select" setPage={setPage} />
                    <h2 className="text-2xl font-bold text-slate-800 mb-2 border-l-4 border-slate-800 pl-3">{identityType === 'ntu' ? 'å°å¤§æ•™è·å“¡å·¥ç”Ÿç¹³è²»' : 'æ ¡å¤–äººå£«ç¹³è²»'}</h2>
                    <div className="bg-orange-50 border border-orange-200 rounded-lg p-4 mb-6">
                        <h3 className="font-bold text-orange-800 flex items-center mb-2"><AlertCircle className="mr-2" /> åŒ¯æ¬¾è³‡è¨Š</h3>
                        <p className="text-sm text-orange-900 mb-2">æœ¬å­¸æœŸç¤¾è²»ï¼š<span className="font-bold text-lg text-red-600">${price}</span></p>
                        <div className="bg-white p-3 rounded border border-orange-100 flex justify-between items-center cursor-pointer active:bg-gray-50" onClick={() => copyToClipboard('88660930767982')}>
                            <div><span className="text-xs text-gray-500 block">å°‡ä¾†éŠ€è¡Œ (823) - é»æ“Šè¤‡è£½</span><span className="font-mono font-bold text-lg">88660930767982</span></div>
                            <Copy className="text-gray-400" />
                        </div>
                    </div>
                    <form onSubmit={(e) => { e.preventDefault(); submitToForm(purchaseData, 'Purchase'); }} className="flex flex-col gap-4">
                        {identityType === 'external' ? (
                            <div className="grid grid-cols-2 gap-3">
                                <div><label className="block text-sm font-medium text-gray-700 mb-1">å§“å</label><input type="text" required className="w-full p-3 border border-gray-300 rounded-lg outline-none focus:ring-2 focus:ring-slate-500" value={purchaseData.name} onChange={(e) => setPurchaseData({...purchaseData, name: e.target.value})} /></div>
                                <div><label className="block text-sm font-medium text-gray-700 mb-1">æ‰‹æ©Ÿ</label><input type="tel" required className="w-full p-3 border border-gray-300 rounded-lg outline-none focus:ring-2 focus:ring-slate-500" value={purchaseData.phone} onChange={(e) => setPurchaseData({...purchaseData, phone: e.target.value})} /></div>
                            </div>
                        ) : (
                            <div>
                                <label className="block text-sm font-medium text-gray-700 mb-1">å§“å</label>
                                <input type="text" required className="w-full p-3 border border-gray-300 rounded-lg outline-none focus:ring-2 focus:ring-slate-500" value={purchaseData.name} onChange={(e) => setPurchaseData({...purchaseData, name: e.target.value})} />
                            </div>
                        )}
                        {identityType === 'ntu' && (
                            <div className="grid grid-cols-2 gap-3">
                                <div><label className="block text-sm font-medium text-gray-700 mb-1">å­¸è™Ÿ</label><input type="text" required className="w-full p-3 border border-gray-300 rounded-lg outline-none uppercase font-mono focus:ring-2 focus:ring-slate-500" value={purchaseData.studentId} onChange={(e) => handleStudentIdChange(e, setPurchaseData, purchaseData)} /></div>
                                <div><label className="block text-sm font-medium text-gray-700 mb-1">ç³»ç´š</label><input type="text" required className="w-full p-3 border border-gray-300 rounded-lg outline-none focus:ring-2 focus:ring-slate-500" value={purchaseData.department} onChange={(e) => setPurchaseData({...purchaseData, department: e.target.value})} /></div>
                            </div>
                        )}
                        <div><label className="block text-sm font-medium text-gray-700 mb-1">åŒ¯æ¬¾å¾Œäº”ç¢¼</label><input type="text" required maxLength={5} className="w-full p-3 border border-gray-300 rounded-lg font-mono text-center tracking-widest outline-none focus:ring-2 focus:ring-slate-500" value={purchaseData.last5} onChange={(e) => setPurchaseData({...purchaseData, last5: e.target.value})} /></div>
                        <button type="submit" disabled={loading} className="mt-4 w-full bg-slate-800 text-white py-4 rounded-xl font-bold text-lg shadow-md hover:bg-slate-900 active:scale-95 transition-all disabled:opacity-50">{loading ? "æäº¤ä¸­..." : "æˆ‘å·²åŒ¯æ¬¾ï¼Œé€å‡ºå ±å"}</button>
                    </form>
                </div>
            );
        };

        const TrialPage = ({ setPage, trialData, setTrialData, loading, submitToForm }) => (
            <div className="p-6 animate-slide-in">
                <BackButton to="home" setPage={setPage} />
                <h2 className="text-2xl font-bold text-slate-800 mb-4 border-l-4 border-slate-800 pl-3">å–®å ‚é«”é©—èª²</h2>
                <div className="bg-orange-50 border border-orange-200 rounded-lg p-4 mb-6">
                    <h3 className="font-bold text-orange-800 flex items-center mb-2"><AlertCircle className="mr-2" /> åŒ¯æ¬¾è³‡è¨Š</h3>
                    <p className="text-sm text-orange-900 mb-2">é«”é©—è²»ç”¨ï¼š<span className="font-bold text-lg">$500 / å ‚</span></p>
                    <div className="bg-white p-3 rounded border border-orange-100 flex justify-between items-center cursor-pointer active:bg-gray-50" onClick={() => copyToClipboard('88660930767982')}>
                        <div><span className="text-xs text-gray-500 block">å°‡ä¾†éŠ€è¡Œ (823)</span><span className="font-mono font-bold text-lg">88660930767982</span></div>
                        <Copy className="text-gray-400" />
                    </div>
                </div>
                <form onSubmit={(e) => { e.preventDefault(); submitToForm(trialData, 'Trial'); }} className="flex flex-col gap-4">
                    <div className="grid grid-cols-2 gap-3">
                        <div><label className="block text-sm font-medium text-gray-700 mb-1">å§“å</label><input type="text" required className="w-full p-3 border border-gray-300 rounded-lg outline-none focus:ring-2 focus:ring-slate-500" value={trialData.name} onChange={(e) => setTrialData({...trialData, name: e.target.value})} /></div>
                        <div><label className="block text-sm font-medium text-gray-700 mb-1">æ‰‹æ©Ÿ</label><input type="tel" required className="w-full p-3 border border-gray-300 rounded-lg outline-none focus:ring-2 focus:ring-slate-500" value={trialData.phone} onChange={(e) => setTrialData({...trialData, phone: e.target.value})} /></div>
                    </div>
                    <div><label className="block text-sm font-medium text-gray-700 mb-1">åŒ¯æ¬¾å¾Œäº”ç¢¼</label><input type="text" required maxLength={5} className="w-full p-3 border border-gray-300 rounded-lg font-mono text-center tracking-widest outline-none focus:ring-2 focus:ring-slate-500" value={trialData.last5} onChange={(e) => setTrialData({...trialData, last5: e.target.value})} /></div>
                    <button type="submit" disabled={loading} className="mt-4 w-full bg-slate-800 text-white py-4 rounded-xl font-bold text-lg shadow-md hover:bg-slate-900 active:scale-95 transition-all disabled:opacity-50">{loading ? "æäº¤ä¸­..." : "é€å‡ºé«”é©—ç™»è¨˜"}</button>
                </form>
            </div>
        );

        const SuccessPage = ({ setPage, onReset }) => (
            <div className="flex flex-col items-center justify-center h-full p-6 animate-scale-in text-center pb-20">
                <div className="w-20 h-20 bg-green-100 rounded-full flex items-center justify-center mb-4"><Check size={40} className="text-green-600" /></div>
                <h2 className="text-2xl font-bold text-gray-800 mb-2">æ“ä½œæˆåŠŸï¼</h2>
                <p className="text-gray-500 mb-6">æ‚¨çš„è³‡æ–™å·²é€å‡ºã€‚</p>
                
                <div className="bg-white p-6 rounded-2xl w-full mb-6 border-2 border-green-500 shadow-sm relative overflow-hidden">
                    <div className="absolute top-0 left-0 w-full bg-green-500 text-white text-xs font-bold py-1">é‡è¦é€šçŸ¥</div>
                    <h3 className="text-lg font-bold text-gray-800 mt-4 mb-2">å°å¤§æ‹³æ“Šç¤¾äº‹é …é€šçŸ¥ç¾¤</h3>
                    <p className="text-sm text-gray-600 mb-4">è«‹å¤§å®¶å‹™å¿…æƒæä¸‹æ–¹ QR Code åŠ å…¥ç¾¤çµ„ï¼</p>
                    
                    <img 
                        src="./qr-code.jpg" 
                        alt="LINE ç¾¤çµ„ QR Code" 
                        className="w-48 h-48 mx-auto object-contain border p-2 rounded-lg" 
                        onError={(e) => {
                            e.target.onerror = null; 
                            e.target.src="https://upload.wikimedia.org/wikipedia/commons/d/d0/QR_code_for_mobile_English_Wikipedia.svg";
                            e.target.title="å¦‚æœæ‚¨çœ‹åˆ°é€™å€‹å‡ QR Codeï¼Œè«‹ç¢ºèªåœ–ç‰‡å·²ä¸Šå‚³è‡³ GitHub ä¸”å‘½åç‚º qr-code.jpg";
                        }} 
                    />
                </div>

                <div className="bg-gray-50 p-4 rounded-lg w-full mb-6 border border-gray-200">
                    <p className="text-sm text-gray-500 mb-1">å®Œæˆæ™‚é–“</p>
                    <p className="font-mono text-lg font-bold text-gray-700">{new Date().toLocaleString('zh-TW', { hour12: false })}</p>
                </div>
                <button type="button" onClick={onReset} className="w-full bg-gray-200 text-gray-700 py-3 rounded-xl font-bold hover:bg-gray-300 transition-all">è¿”å›é¦–é </button>
            </div>
        );

        function App() {
            const [page, setPage] = useState('home');
            const [loading, setLoading] = useState(false);
            const [identityType, setIdentityType] = useState('ntu'); 
            
            const [memberData, setMemberData] = useState({ studentId: '', phone: '', name: '' });
            const [purchaseData, setPurchaseData] = useState({ name: '', studentId: '', department: '', phone: '', last5: '' });
            const [trialData, setTrialData] = useState({ name: '', phone: '', last5: '' });

            // ======= è®€å– Google è³‡æ–™åº« =======
            const [membersDb, setMembersDb] = useState([]);
            const [isDbLoaded, setIsDbLoaded] = useState(false);

            useEffect(() => {
                // ç¶²é è¼‰å…¥æ™‚ï¼Œç™¼é€ GET è«‹æ±‚å»æŠ“æœƒå“¡åå–®
                if (GOOGLE_SCRIPT_URL && !GOOGLE_SCRIPT_URL.includes("è«‹å°‡æ‚¨çš„")) {
                    fetch(GOOGLE_SCRIPT_URL)
                        .then(res => res.json())
                        .then(data => {
                            if (Array.isArray(data)) {
                                setMembersDb(data);
                                setIsDbLoaded(true);
                                console.log("æœƒå“¡è³‡æ–™åº«è¼‰å…¥æˆåŠŸï¼å…±", data.length, "ç­†");
                            }
                        })
                        .catch(err => console.error("è®€å–æœƒå“¡åº«å¤±æ•—:", err));
                }
            }, []);
            // ==================================

            const handleStudentIdChange = (e, setter, currentData) => {
                const val = e.target.value.toUpperCase();
                setter({ ...currentData, studentId: val });
            };

            const submitToForm = async (data, type) => {
                setLoading(true);
                
                // ------------------------------------------
                // è·¯ç·š Aï¼šç¤¾å“¡ç°½åˆ° -> é€åˆ° Google Apps Script
                // ------------------------------------------
                if (type === 'Member') {
                    if (GOOGLE_SCRIPT_URL.includes("è«‹å°‡æ‚¨çš„_Apps_Script_ç¶²å€è²¼åœ¨é€™è£¡")) {
                        alert("ã€é–‹ç™¼æç¤ºã€‘\næ‚¨å°šæœªå¡«å¯« Google Apps Script çš„ç¶²å€ï¼\nè«‹å…ˆä¾ç…§æ•™å­¸å»ºç«‹ Apps Scriptã€‚");
                        setLoading(false);
                        return;
                    }

                    // ====== æœƒå“¡åå–®å¯¦æ™‚æ¯”å°é©—è­‰ ======
                    if (isDbLoaded && membersDb.length > 0) {
                        // åœ¨æ’ˆå‡ºä¾†çš„è³‡æ–™åº«ä¸­æ‰¾é€™åå­—
                        const isValidMember = membersDb.some(row => {
                            // è€ƒé‡åˆ° Google Form è¡¨é ­å¯èƒ½å‘½åç‚º "å§“å", "NAME", "Name"ï¼Œåšå¤šé‡å®¹éŒ¯
                            const dbName = String(row['å§“å'] || row['NAME'] || row['Name'] || '').trim();
                            return dbName === data.name.trim();
                        });

                        if (!isValidMember) {
                            alert(`ã€æŸ¥ç„¡æœƒå“¡è³‡æ–™ã€‘\nè³‡æ–™åº«ä¸­æ‰¾ä¸åˆ°ã€Œ${data.name}ã€çš„ç´€éŒ„ï¼\n\n1. è«‹ç¢ºèªæ‚¨æ˜¯å¦å·²å®Œæˆã€Œè³¼è²·èª²ç¨‹ã€æˆ–ã€Œæˆ‘è¦é«”é©—ã€ç™»è¨˜ã€‚\n2. ç¢ºä¿æ‚¨è¼¸å…¥çš„å§“åèˆ‡è¡¨å–®å¡«å¯«å®Œå…¨ç›¸åŒã€‚`);
                            setLoading(false);
                            return; // çµ‚æ­¢ç™¼é€
                        }
                    } else if (!isDbLoaded && !GOOGLE_SCRIPT_URL.includes("è«‹å°‡æ‚¨çš„")) {
                        console.warn("âš ï¸ æœƒå“¡è³‡æ–™åº«å°šæœªè¼‰å…¥å®Œæˆï¼Œç›´æ¥æ”¾è¡Œæ¸¬è©¦");
                    }
                    // ==================================

                    // æ•´ç†è¦é€åˆ° Apps Script çš„ JSON è³‡æ–™ (ç§»é™¤ date)
                    const payload = {
                        action: "member_checkin",
                        timestamp: new Date().toLocaleString('zh-TW'),
                        identity: identityType === 'ntu' ? 'NTU' : 'External',
                        studentId: identityType === 'ntu' ? data.studentId : '',
                        phone: identityType === 'external' ? data.phone : '',
                        name: data.name
                    };

                    try {
                        await fetch(GOOGLE_SCRIPT_URL, {
                            method: "POST",
                            mode: "no-cors", 
                            headers: { "Content-Type": "application/json" },
                            body: JSON.stringify(payload)
                        });
                        
                        setTimeout(() => {
                            setLoading(false);
                            setPage('success');
                        }, 1000);
                    } catch (err) {
                        console.error("Apps Script ç™¼é€å¤±æ•—", err);
                        alert("é€£ç·šç™¼ç”ŸéŒ¯èª¤ï¼Œè«‹æª¢æŸ¥ç¶²è·¯ã€‚");
                        setLoading(false);
                    }

                // ------------------------------------------
                // è·¯ç·š Bï¼šè³¼è²·èª²ç¨‹ / é«”é©—èª² -> é€åˆ° Google Form
                // ------------------------------------------
                } else {
                    let finalType = type;
                    if (type === 'Purchase') {
                        finalType = `Purchase_${identityType === 'ntu' ? 'NTU' : 'External'}`;
                    } else if (type === 'Trial') {
                        finalType = 'Trial';
                    }

                    let phoneValue = data.phone || "";
                    if (type === 'Purchase' && identityType === 'ntu') {
                        phoneValue = "";
                    }

                    const entries = {
                        "entry.279954985": finalType || "",
                        "entry.697528972": data.name || "",
                        "entry.1784570342": phoneValue || "",
                        "entry.1864980518": data.studentId || "",
                        "entry.2007099999": data.department || "",
                        "entry.219588854": data.last5 || ""
                    };

                    const form = document.createElement('form');
                    form.action = FORM_URL;
                    form.method = 'POST';
                    form.target = 'hidden_iframe'; 

                    for (const [key, value] of Object.entries(entries)) {
                        const input = document.createElement('input');
                        input.type = 'hidden';
                        input.name = key;
                        input.value = value;
                        form.appendChild(input);
                    }

                    document.body.appendChild(form);
                    
                    form.submit();

                    setTimeout(() => {
                        setLoading(false);
                        setPage('success');
                        document.body.removeChild(form);
                    }, 1500);
                }
            };

            const resetAndGoHome = () => {
                setPage('home');
                setMemberData({studentId: '', phone: '', name: ''});
                setPurchaseData({name: '', studentId: '', department: '', phone: '', last5: ''});
                setTrialData({name: '', phone: '', last5: ''});
            };

            return (
                <div className="min-h-screen bg-gray-100 flex justify-center font-sans">
                    <div className="w-full max-w-md bg-white min-h-screen shadow-xl relative flex flex-col">
                        {page !== 'success' && <Header />}
                        
                        <main className="flex-1">
                            {page === 'home' && <HomePage setPage={setPage} />}
                            
                            {page === 'member_select' && (
                                <IdentitySelectPage title="ç¤¾å“¡ç°½åˆ°" nextStep="member_form" setPage={setPage} setIdentityType={setIdentityType} />
                            )}
                            
                            {page === 'member_form' && (
                                <MemberFormPage 
                                    setPage={setPage} 
                                    identityType={identityType} 
                                    memberData={memberData} 
                                    setMemberData={setMemberData} 
                                    loading={loading} 
                                    submitToForm={submitToForm}
                                    handleStudentIdChange={handleStudentIdChange}
                                />
                            )}
                            
                            {page === 'purchase_select' && (
                                <IdentitySelectPage title="è³¼è²·èª²ç¨‹" nextStep="purchase_form" setPage={setPage} setIdentityType={setIdentityType} />
                            )}
                            
                            {page === 'purchase_form' && (
                                <PurchaseFormPage 
                                    setPage={setPage} 
                                    identityType={identityType} 
                                    purchaseData={purchaseData} 
                                    setPurchaseData={setPurchaseData} 
                                    loading={loading} 
                                    submitToForm={submitToForm}
                                    handleStudentIdChange={handleStudentIdChange}
                                />
                            )}
                            
                            {page === 'trial' && (
                                <TrialPage 
                                    setPage={setPage} 
                                    trialData={trialData} 
                                    setTrialData={setTrialData} 
                                    loading={loading} 
                                    submitToForm={submitToForm} 
                                />
                            )}
                            
                            {page === 'success' && (
                                <SuccessPage setPage={setPage} onReset={resetAndGoHome} />
                            )}
                        </main>
                    </div>
                </div>
            );
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
